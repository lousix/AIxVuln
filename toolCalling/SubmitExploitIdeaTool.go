package toolCalling

import (
	"AIxVuln/taskManager"
)

type SubmitExploitIdeaTool struct {
	task *taskManager.Task
}

func NewSubmitExploitIdeaTool(task *taskManager.Task) *SubmitExploitIdeaTool {
	return &SubmitExploitIdeaTool{task: task}
}

func (h *SubmitExploitIdeaTool) Name() string {
	return "SubmitExploitIdeaTool"
}
func (h *SubmitExploitIdeaTool) Description() string {
	return "If you complete the verification of a exploitIdea (regardless of success or failure), you need to collect runtime evidence of the verification outcome, write a Python attack script, and call this tool. This tool will return a new task or an instruction to end the task to you.The report must be in Chinese."
}
func (h *SubmitExploitIdeaTool) Parameters() map[string]interface{} {
	return map[string]interface{}{
		"type": "object",
		"properties": map[string]interface{}{
			"exploitIdeaId": map[string]interface{}{
				"type":        "string",
				"description": "exploitIdeaId, example: E.1.(required)",
			},
			"exploitIdea_status": map[string]interface{}{
				"type":        "string",
				"enum":        []string{"Completed", "Failed"},
				"description": "exploitIdea status needs to be set.(required)",
			},
			"evidence": map[string]interface{}{
				"type":        "string",
				"description": "Fill in the runtime verification evidence for the specified environment, which must include the execution results.(required)",
			},
			"Poc": map[string]interface{}{
				"type":        "string",
				"description": "If verification is successful, you can pass in a Python script that verifies the existence of the vulnerability (optional).",
			},
		},
	}
}

func (h *SubmitExploitIdeaTool) Execute(parameters map[string]interface{}) string {
	VulnIdTemp := parameters["exploitIdeaId"]
	if VulnIdTemp == nil {
		return Fail("Missing 'exploitIdeaId' parameter")
	}
	VulnIdStr := VulnIdTemp.(string)
	if len(VulnIdStr) < 3 {
		return Fail("exploitIdeaId too short")
	}

	VulnStatusTemp := parameters["exploitIdea_status"]
	if VulnStatusTemp == nil {
		return Fail("Missing 'exploitIdea_status' parameter")
	}
	VulnStatus := VulnStatusTemp.(string)

	EvidenceTemp := parameters["evidence"]
	if EvidenceTemp == nil {
		return Fail("Missing 'evidence' parameter")
	}
	Evidence := EvidenceTemp.(string)

	var Poc string
	PocTemp := parameters["Poc"]
	if PocTemp != nil {
		Poc = PocTemp.(string)
	}

	err := h.task.GetExploitIdeaHandler()(VulnIdStr, VulnStatus, Evidence, Poc)
	if err != nil {
		return Fail(err.Error())
	}
	return Success("success")
}
