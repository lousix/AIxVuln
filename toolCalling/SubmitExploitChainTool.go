package toolCalling

import (
	"AIxVuln/taskManager"
)

type SubmitExploitChainTool struct {
	task *taskManager.Task
}

func NewSubmitExploitChainTool(task *taskManager.Task) *SubmitExploitChainTool {
	return &SubmitExploitChainTool{task: task}
}

func (h *SubmitExploitChainTool) Name() string {
	return "SubmitExploitChainTool"
}
func (h *SubmitExploitChainTool) Description() string {
	return "If you complete the verification of a exploitChain (regardless of success or failure), you need to collect runtime evidence of the verification outcome, write a Python attack script, and call this tool. This tool will return a new task or an instruction to end the task to you.The report must be in Chinese."
}
func (h *SubmitExploitChainTool) Parameters() map[string]interface{} {
	return map[string]interface{}{
		"type": "object",
		"properties": map[string]interface{}{
			"exploitChainId": map[string]interface{}{
				"type":        "string",
				"description": "exploitChainId, example: C.1.(required)",
			},
			"exploitChain_status": map[string]interface{}{
				"type":        "string",
				"enum":        []string{"Completed", "Failed"},
				"description": "exploitChain status needs to be set.(required)",
			},
			"evidence": map[string]interface{}{
				"type":        "string",
				"description": "Fill in the runtime verification evidence for the specified environment, which must include the execution results.(required)",
			},
			"Poc": map[string]interface{}{
				"type":        "string",
				"description": "If verification is successful, you can pass in a Python script that verifies the existence of the vulnerability (optional).",
			},
		},
	}
}

func (h *SubmitExploitChainTool) Execute(parameters map[string]interface{}) string {
	VulnIdTemp := parameters["exploitChainId"]
	if VulnIdTemp == nil {
		return Fail("Missing 'exploitChainId' parameter")
	}
	VulnIdStr := VulnIdTemp.(string)
	if len(VulnIdStr) < 3 {
		return Fail("exploitChainId too short")
	}

	VulnStatusTemp := parameters["exploitChain_status"]
	if VulnStatusTemp == nil {
		return Fail("Missing 'exploitChain_status' parameter")
	}
	VulnStatus := VulnStatusTemp.(string)

	EvidenceTemp := parameters["evidence"]
	if EvidenceTemp == nil {
		return Fail("Missing 'evidence' parameter")
	}
	Evidence := EvidenceTemp.(string)

	var Poc string
	PocTemp := parameters["Poc"]
	if PocTemp != nil {
		Poc = PocTemp.(string)
	}
	err := h.task.GetExploitChainHandler()(VulnIdStr, VulnStatus, Evidence, Poc)
	if err != nil {
		return Fail(err.Error())
	}
	return Success("success")
}
